<!doctype html>
<meta charset="utf-8" />
<script>
	//UI-width / device-width * window.devicePixelRatio * 160
	var designWidth = 320;
	if(/Android/i.test(navigator.userAgent)){
		var dpi = Math.round(designWidth/window.screen.width*window.devicePixelRatio*160);
		document.write('<meta name="viewport" content="target-densitydpi='+dpi+',width='+designWidth+',user-scalable=no" />');
	}else{
		//var scale = window.innerWidth/320;
		document.write('<meta name="viewport" content="width='+designWidth+',user-scalable=no" />');
	}
</script>
<link rel="stylesheet" href="all.css" />
<script src="const/define.js"></script>
<script src="const/name.js"></script>
<script src="const/job.js"></script>
<script src="const/tag.js"></script>
<script src="model/tagset.js"></script>
<script src="model/maid.js"></script>
<script src="model/customer.js"></script>
<script src="lib/ui.js"></script>
<body>
<div id="main_container">
	<div class="event_top">
		<h1>营业活动</h1>
	</div>
	<div class="custom_head">
		<h2>目标客户</h2>
		<span class="queue"></span>
	</div>
	<div class="customer_cont"></div>
	<div class="rival_head">
		<h2>竟争者</h2>
	</div>
	<div class="rival_cont"></div>
	<div class="self_head">
		<h2>我</h2>
	</div>
	<div class="scroll_panel">
		<div class="scroll_container"></div>
	</div>
	<div class="scroll_button">
		<div class="prev"></div>
		<div class="next"></div>
	</div>
	<div class="scroll_point"></div>
	<div class="action">
		<button class="btn_blue btn_large">派出招揽</button>
	</div>
	<div class="result"><div class="title">招揽结果</div><div class="cutin"></div><b class="hint_tap">TAP SCREEN</b></div>
</div>
<script>
var customerData=[
	createCustomer('纳撒尼尔','刚刚与女友分手，心情很差，希望到这里可以重拾信心。',301,20000,ELEMENT_SEXY,SPECTYPE_NULL,0,AFFECTTYPE_TECHNIC,1),
	createCustomer('弗雷德里克','对新鲜的事物充满好奇的他，想在这里找到不一样的体验。',303,8000,ELEMENT_FASHION,SPECTYPE_TAG,8010,AFFECTTYPE_TAG,2031)
],rivalData={
	'萌萌猫耳娘主题咖啡馆':[
		createMaid('马琳',21,48,26,76,86,90,18,0,[1011]),
		createMaid('埃莉诺',9,41,9,82,74,90,19,0,[5010,10010])
	]
},mineData=[
	createMaid('丹妮尔',7,39,77,35,55,90,17,0,[12010]),
	createMaid('莉莲',8,23,91,19,73,90,18,0,[8010])
];

var currCustomer = null, currRivalIndex = {};

newCustomerShow();
rivalShow();
document.querySelector('.scroll_panel').dataset.totalChara = mineData.length;
for(var i=0;i<mineData.length;i++){
	var node = UI.createCharaBoxS(mineData[i],1,'大正浪漫女仆咖啡屋');
	node.className = 'scroll_node';
	document.querySelector('.scroll_container').appendChild(node);
	var pt = document.createElement('b');
	if(i==0){
		pt.className = 'curr';
	}
	document.querySelector('.scroll_point').appendChild(pt);
}

function nextRound(){
	newCustomerShow();
	rivalShow();
}

function newCustomerShow(){
	var cont = document.querySelector('.customer_cont');
	if(cont.childNodes.length>0){
		cont.childNodes[0].className = 'out';
		setTimeout(function(){cont.removeChild(cont.childNodes[0])},300);
		document.querySelector('.custom_head .queue .a').className = 'u';
	}else{
		for(var i=0;i<customerData.length;i++){
			document.querySelector('.custom_head .queue').innerHTML += '<b class="a"></b>';
		}
	}
	if(customerData.length>0){
		currCustomer = customerData.shift();
		var cElem = UI.createCustomBoxC(currCustomer);
		cont.appendChild( cElem );
		setTimeout(function(){cElem.className='in'},10);
	}
}

function rivalMaidShow(shop){
	var cont = document.querySelector('.rival_cont');
	var rElem = UI.createCharaBoxS(rivalData[shop][currRivalIndex[shop]],2,shop);
	cont.appendChild( rElem );
}

function selectRivalMaid(shop){
	var targetElement = currCustomer.likeValue;
	for(var i=0;i<rivalData[shop].length;i++){
		if(i==0){
			currRivalIndex[shop] = i;
		}else if(rivalData[shop][i].getValueByElement(targetElement)>rivalData[shop][currRivalIndex[shop]].getValueByElement(targetElement)){
			currRivalIndex[shop] = i;
		}
	}
	rivalMaidShow(shop);
}

function rivalShow(){
	document.querySelector('.rival_cont').innerHTML = '';
	for(var shop in rivalData){
		selectRivalMaid(shop);
	}
}

function randomNamePic(gender){
	if(gender==1){
		return [MALE_NAMES[Math.floor(Math.random()*MALE_NAMES.length)],Math.ceil(Math.random()*5)+300];
	}else{
		return [FEMALE_NAMES[Math.floor(Math.random()*FEMALE_NAMES.length)],Math.ceil(Math.random()*26)];
	}
}

function createCustomer(name,desc,pic,price,like,specType,specValue,affectType,affectValue){
	var c = new Customer();
	c.name = name;
	c.desc = desc;
	c.pic = pic;
	c.priceValue = price;
	c.likeValue = like;
	c.specValue.type = specType;
	c.specValue.value = specValue;
	c.affectValue.type = affectType;
	c.affectValue.value = affectValue;
	return c;
}

function createMaid(name,pic,fashion,pure,sexy,technic,health,age,job,tags){
	var t = [0,name,pic,fashion,100,pure,100,sexy,100,technic,health,0,100,age,job,[5].concat(tags).join('-')].join(',');
	return new Maid(t);
}

function close_cutin(){
	document.querySelector('.result').style.display = 'none';
	document.querySelector('.result').removeEventListener('touchend',close_cutin,false);
	document.querySelector('.result .hint_tap').style.display = '';
	document.querySelector('.cutin').innerHTML = '';

	nextRound();
}
function cutin_control(stagePic,customer,rivals,mine,result){
	var pCounter = 1, cutinStage = document.querySelector('.cutin');
	document.querySelector('.result').style.display = 'block';
	cutinStage.dataset.stagePic = stagePic;

	for(var i=0;i<rivals.length;i++){
		cutinStage.appendChild( UI.createCutinHead(rivals[i],pCounter++,2) );
	}
	cutinStage.appendChild( UI.createCutinHead(mine,pCounter,1) );
	cutinStage.dataset.totalChara = pCounter;

	var c = UI.createCutinHead(customer,0,3);
	cutinStage.appendChild(c);
	c.innerHTML = '<b class="anim_ellipsis"></b>';
	setTimeout(function(){
		c.innerHTML = '';
		c.dataset.result = result;
		setTimeout(function(){
			c.innerHTML = '<b class="anim_heart"></b>';
			setTimeout(function(){
				document.querySelector('.result .hint_tap').style.display = 'block';
				document.querySelector('.result').addEventListener('touchend',close_cutin,false);
			},600);
		},250);
	},4000);
}

document.querySelector('.action button').addEventListener('touchend',function(){
	var mineMaid = mineData[scroller.currentIndex];
	var highScore = {pos:0,score:0};
	var pos = 0;
	var rivalMaidPicArray = [];
	for(var shop in currRivalIndex){
		pos++;
		var maid = rivalData[shop][currRivalIndex[shop]];
		rivalMaidPicArray.push( maid.pic );
		var score = maid.getValueByElement(currCustomer.likeValue);
		if(currCustomer.specValue.type==1){
			var m = maid.tags.match(currCustomer.specValue.value);
			if(m>0){
				score*=m-98;
			}else if(m<0){
				score=0;
			}
			if(score>highScore.score){
				highScore.score = score;
				highScore.pos = pos;
			}
		}
	}
	pos++;
	var score = mineMaid.getValueByElement(currCustomer.likeValue);
	if(currCustomer.specValue.type==1){
		var m = mineMaid.tags.match(currCustomer.specValue.value);
		if(m>0){
			score*=m-98;
		}else if(m<0){
			score=0;
		}
		if(score>highScore.score){
			highScore.score = score;
			highScore.pos = pos;
		}
	}
	cutin_control(1,currCustomer.pic,rivalMaidPicArray,mineMaid.pic,highScore.pos);
},false);

var scroller = UI.makeScroller(document.querySelector('.scroll_panel'),document.querySelector('.scroll_point'),document.querySelector('.scroll_button .prev'),document.querySelector('.scroll_button .next'),mineData.length);
</script>