<!doctype html>
<meta charset="utf-8" />
<script>
	if(!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
		var s = encodeURIComponent(location.href);
		location.replace('qrcode.html?url='+s);
	}
	//UI-width / device-width * window.devicePixelRatio * 160
	var designWidth = 320;
	if(/Android/i.test(navigator.userAgent)){
		var dpi = Math.round(designWidth/window.screen.width*window.devicePixelRatio*160);
		document.write('<meta name="viewport" content="target-densitydpi='+dpi+',width='+designWidth+',user-scalable=no" />');
	}else{
		//var scale = window.innerWidth/320;
		document.write('<meta name="viewport" content="width='+designWidth+',user-scalable=no" />');
	}
</script>
<link rel="stylesheet" href="all.css" />
<script src="const/define.js"></script>
<script src="const/name.js"></script>
<script src="const/job.js"></script>
<script src="const/tag.js"></script>
<script src="model/tagset.js"></script>
<script src="model/maid.js"></script>
<script src="model/customer.js"></script>
<script src="lib/ui.js"></script>
<script src="lib/guide.js"></script>
<body>
<div id="main_container">
	<div class="event_top">
		<h1>营业活动</h1>
	</div>
	<div class="custom_head">
		<h2>目标客户</h2>
		<span class="queue"></span>
	</div>
	<div class="customer_cont"></div>
	<div class="rival_head">
		<h2>竟争者</h2>
	</div>
	<div class="rival_cont"></div>
	<div class="self_head">
		<h2>我</h2>
	</div>
	<div class="scroll_panel">
		<div class="scroll_container"></div>
	</div>
	<div class="scroll_button">
		<div class="prev"></div>
		<div class="next"></div>
	</div>
	<div class="scroll_point"></div>
	<div class="action">
		<button class="btn_blue btn_large">派出招揽</button>
	</div>
	<div class="result"><div class="title">招揽结果</div><div class="cutin"></div><b class="hint_tap">TAP SCREEN</b></div>
</div>
<script>
var isUsingMouse = false, isLockingSubmit = false;

var customerData=[
	createCustomer('纳撒尼尔','刚刚与女友分手，心情很差，希望到这里可以重拾信心。',301,20000,ELEMENT_SEXY,SPECTYPE_NULL,0,AFFECTTYPE_TECHNIC,1),
	createCustomer('弗雷德里克','对新鲜的事物充满好奇的他，想在这里找到不一样的体验。',303,8000,ELEMENT_FASHION,SPECTYPE_TAG,8010,AFFECTTYPE_TAG,2031)
],rivalData={
	'萌萌猫耳娘主题咖啡馆':[
		createMaid('马琳',21,48,26,66,86,90,18,0,[1011]),
		createMaid('埃莉诺',9,41,9,72,74,90,19,0,[5010,10010])
	]
},mineData=[
	createMaid('丹妮尔',7,39,77,35,55,90,17,0,[12010]),
	createMaid('莉莲',8,27,91,19,73,90,18,0,[8010])
];

var currCustomer = null, currRivalIndex = {};

newCustomerShow();
rivalShow();
document.querySelector('.scroll_panel').dataset.totalChara = mineData.length;
for(var i=0;i<mineData.length;i++){
	var node = UI.createCharaBoxS(mineData[i],1,'大正浪漫女仆咖啡屋');
	node.className = 'scroll_node';
	document.querySelector('.scroll_container').appendChild(node);
	var pt = document.createElement('b');
	if(i==0){
		pt.className = 'curr';
	}
	document.querySelector('.scroll_point').appendChild(pt);
}

function nextRound(){
	newCustomerShow();
	if(document.querySelector('.custom_head .queue .a')){
		rivalShow();
	}else{
		console.log('end');
	}
}

function newCustomerShow(){
	var cont = document.querySelector('.customer_cont');
	if(cont.childNodes.length>0){
		cont.childNodes[0].className = 'out';
		setTimeout(function(){cont.removeChild(cont.childNodes[0])},300);
		document.querySelector('.custom_head .queue .a').className = 'u';
	}else{
		for(var i=0;i<customerData.length;i++){
			document.querySelector('.custom_head .queue').innerHTML += '<b class="a"></b>';
		}
	}
	if(customerData.length>0){
		currCustomer = customerData.shift();
		var cElem = UI.createCustomBoxC(currCustomer);
		cont.appendChild( cElem );
		setTimeout(function(){cElem.className='in'},10);
	}
}

function rivalMaidShow(shop){
	var cont = document.querySelector('.rival_cont');
	var rmIdx = currRivalIndex[shop];
	if(rmIdx>=0){
		var rElem = UI.createCharaBoxS(rivalData[shop][rmIdx],2,shop);
	}else{
		var rElem = UI.createEmptyCharaBoxS(shop);
	}
	cont.appendChild( rElem );
	setTimeout(function(){rElem.className='in'},10);
}

function rivalAutoSelectMaid(shop){
	var targetElement = currCustomer.likeValue;
	currRivalIndex[shop] = -1;
	for(var i=0;i<rivalData[shop].length;i++){
		if(i==0){
			currRivalIndex[shop] = i;
		}else if(rivalData[shop][i].getValueByElement(targetElement)>rivalData[shop][currRivalIndex[shop]].getValueByElement(targetElement)){
			currRivalIndex[shop] = i;
		}
	}
	rivalMaidShow(shop);
}

function rivalShow(){
	document.querySelector('.rival_cont').innerHTML = '';
	for(var shop in rivalData){
		rivalAutoSelectMaid(shop);
	}
}

function randomNamePic(gender){
	if(gender==1){
		return [MALE_NAMES[Math.floor(Math.random()*MALE_NAMES.length)],Math.ceil(Math.random()*5)+300];
	}else{
		return [FEMALE_NAMES[Math.floor(Math.random()*FEMALE_NAMES.length)],Math.ceil(Math.random()*26)];
	}
}

function randomIntNumber(min,max){
	return Math.round(Math.random()*(max-min))+min;
}

function createCustomer(name,desc,pic,price,like,specType,specValue,affectType,affectValue){
	var c = new Customer();
	c.name = name;
	c.desc = desc;
	c.pic = pic;
	c.priceValue = price;
	c.likeValue = like;
	c.specValue.type = specType;
	c.specValue.value = specValue;
	c.affectValue.type = affectType;
	c.affectValue.value = affectValue;
	return c;
}

function createMaid(name,pic,fashion,pure,sexy,technic,health,age,job,tags){
	var t = [0,name,pic,fashion,100,pure,100,sexy,100,technic,health,0,100,age,job,[5].concat(tags).join('-')].join(',');
	return new Maid(t);
}

function close_cutin(){
	document.querySelector('.result').style.display = 'none';
	document.querySelector('.result').removeEventListener('touchend',close_cutin,false);
	document.querySelector('.result .hint_tap').style.display = '';
	document.querySelector('.cutin').innerHTML = '';

	nextRound();
	setTimeout(function(){isLockingSubmit=false},100);
}
function cutin_control(stagePic,customer,rivals,mine,result){
	var pCounter = 1, cutinStage = document.querySelector('.cutin');
	document.querySelector('.result').style.display = 'block';
	cutinStage.dataset.stagePic = stagePic;

	for(var i=0;i<rivals.length;i++){
		cutinStage.appendChild( UI.createCutinHead(rivals[i],pCounter++,2) );
	}
	cutinStage.appendChild( UI.createCutinHead(mine,pCounter,1) );
	cutinStage.dataset.totalChara = pCounter;

	var c = UI.createCutinHead(customer,0,3);
	cutinStage.appendChild(c);
	c.innerHTML = '<b class="anim_ellipsis"></b>';
	setTimeout(function(){
		c.innerHTML = '';
		c.dataset.result = result;
		setTimeout(function(){
			c.innerHTML = '<b class="anim_heart"></b>';
			setTimeout(function(){
				document.querySelector('.result .hint_tap').style.display = 'block';
				document.querySelector('.result').addEventListener('touchend',close_cutin,false);
			},600);
		},250);
	},4000);
}

document.querySelector('.action button').addEventListener('touchend',function(){
	if(isLockingSubmit){
		return;
	}
	isLockingSubmit = true;
	var mineMaid = mineData[scroller.currentIndex];
	var highScore = {pos:0,score:0};
	var pos = 0;
	var rivalMaidPicArray = [];
	for(var shop in currRivalIndex){
		var idx = currRivalIndex[shop];
		if(idx<0){
			continue;
		}
		var maid = rivalData[shop][idx];
		rivalMaidPicArray.push( maid.pic );
		calcScore(maid);
	}
	calcScore(mineMaid);
	if(highScore.pos==pos){
		//mine is win;
		document.querySelectorAll('.scroll_container .scroll_node')[scroller.currentIndex].querySelector('.chara_box_s').dataset.bgType = 4;
	}else{
		//mine is lose;
		var c=1;
		for(var shop in currRivalIndex){
			if(currRivalIndex[shop]==-1){
				continue;
			}
			if(c++==highScore.pos){
				//remove winner
				var m = rivalData[shop].splice(currRivalIndex[shop],1)[0];
			}
		}
	}
	function calcScore(maid){
		pos++;
		var score = maid.getValueByElement(currCustomer.likeValue);
		if(currCustomer.specValue.type==1){
			var m = maid.tags.match(currCustomer.specValue.value);
			if(m>0){
				score*=m-96;//4倍
			}else if(m<0){
				score=0;
			}
		}
		if(score>highScore.score){
			highScore.score = score;
			highScore.pos = pos;
		}
	}
	cutin_control(1,currCustomer.pic,rivalMaidPicArray,mineMaid.pic,highScore.pos);
},false);

var scroller = UI.makeScroller(document.querySelector('.scroll_panel'),document.querySelector('.scroll_point'),document.querySelector('.scroll_button .prev'),document.querySelector('.scroll_button .next'),mineData.length);

Guide.start([
	['pauseByTime',300],
	['clipRect',0,0,0,0],
	['pauseByTime',100],
	['tourAnim','show'],
	['pauseByTime',280],
	['tourSerifShow'],
	['tourSerifSay','啊，欢迎光临 大正浪漫女仆咖啡屋！'],
	['pauseUntilTapScreen'],
	['tourEmotion','smile'],
	['tourAnim','jump'],
	['tourSerifAddLine','今天我们的推荐是番茄酱蛋包饭，请问客人要来一份吗？'],
	['pauseUntilTapScreen'],
	['tourEmotion','smile2'],
	['tourAnim','jump'],
	['tourSerifSay','其实是骗你的啦！我知道你就是新来的店长对不对！'],
	['pauseUntilTapScreen'],
	['tourEmotion','surprise2'],
	['tourAnim','jump'],
	['tourSerifSay','什么！第一天上任就要马上进入工作状态了吗？'],
	['pauseUntilTapScreen'],
	['tourEmotion','smile2'],
	['tourAnim','jump'],
	['tourSerifAddLine','我知道了，那么就让我来演示一遍我们店的工作流程吧！'],
	['pauseUntilTapScreen'],
	['tourSerifHide'],
	['tourAnim','leave'],
	['clipRect',2,45,316,160],//目标客户
	['typeText','最上方显示的是目标客户的信息',10,230],
	['pauseUntilTapScreen'],
	['clipRect',3,356,316,164],//我
	['typeText','下方这里则是我们店里的女仆',10,300],
	['pauseUntilTapScreen'],
	['clipRect',3,210,316,142],//竟争者
	['typeText','中间这里显示的是其它店的女仆',10,380],
	['pauseUntilTapScreen'],
	['typeText','营业活动的时候，主要工作内容就是和其它店争夺客户了！',10,380],
	['pauseUntilTapScreen'],
	['clipRect',7,281,210,42],//五属性
	['typeText','每一个女仆都会有着像上面的显示的几种属性',10,350],
	['pauseUntilTapScreen'],
	['typeText','属性值从高到低分别是<br />S > A > B > C > D',10,350],
	['pauseUntilTapScreen'],
	['typeText','有加减号的情况下，N+ > N > N-',10,350],
	['pauseUntilTapScreen'],
	['clipRect',125,155,58,24],//性感派
	['typeText','对应的，客户这里会显示一个派系',10,200],
	['pauseUntilTapScreen'],
	['typeText','像现在的目标客户是性感派的话...',10,200],
	['pauseUntilTapScreen'],
	['clipRect',147,280,68,23],//性感 A
	['typeText','女仆的性感值越高就会对他越有吸引力了',10,240],
	['pauseUntilTapScreen'],
	['clipRect',147,425,68,23],//性感 B-
	['typeText','竞争对手的女仆性感值是A，我们只要比她高就可以抢到客户了...',10,350],
	['pauseUntilTapScreen'],
	['clipRect',0,0,0,0],
	['clearText'],
	['tourAnim','show'],
	['tourEmotion','sad'],
	['pauseByTime',280],
	['tourSerifShow'],
	['tourSerifSay','诶嘿嘿...似乎不是很乐观呢...'],
	['pauseUntilTapScreen'],
	['tourEmotion','fight'],
	['tourAnim','jump'],
	['tourSerifAddLine','不...不要紧，我们还有一位女仆呢！'],
	['pauseUntilTapScreen'],
	['tourAnim','jump'],
	['tourSerifAddLine','只要换上她的话，一定可以赢的！大概！'],
	['pauseUntilTapScreen'],
	['tourAnim','jump'],
	['tourSerifSay','好，那我们就赶快换上来吧！'],
	['pauseUntilTapScreen'],
	['tourSerifHide'],
	['tourAnim','leave'],
	['clipRect',302,424,18,50],//右箭头
	['typeText','点击右边的箭头来切换女仆',10,440],
	['pauseUntilTapRect',302,424,18,50],
	['clearText'],
	['simTouchElement','.next'],
	['clearClipRect'],
	['pauseByTime',3000],
	['clipRect',0,0,0,0],
	['tourAnim','show'],
	['tourEmotion','stun'],
	['pauseByTime',280],
	['tourSerifShow'],
	['tourSerifSay','好...好像更糟糕了，怎么办！'],
	['pauseUntilTapScreen'],
	['tourEmotion','sad2'],
	['tourAnim','jump'],
	['tourSerifAddLine','但是我们已经没有更多的女仆了，不管怎么样也只好派遣她去了。'],
	['pauseUntilTapScreen'],
	['tourEmotion','sigh'],
	['tourAnim','jump'],
	['tourSerifAddLine','还想好好表现一下给新店长看看的，没想到马上就失败了，真是大失策。'],
	['pauseUntilTapScreen'],
	['tourSerifHide'],
	['tourAnim','leave'],
	['clipRect',109,522,102,46],//派遣
	['typeText','点击下面的按钮派遣女仆',10,470],
	['pauseUntilTapRect',109,522,102,46],
	['clearText'],
	['simTouchElement','.action button'],
	['clearClipRect'],
	['pauseByTime',4850],
	['pauseUntilTapScreen'],
	['simTouchElement','.result'],
	['clipRect',0,0,0,0],
	['tourAnim','show'],
	['tourEmotion','sigh'],
	['pauseByTime',280],
	['tourSerifShow'],
	['tourSerifSay','果然失败了呢...'],
	['pauseUntilTapScreen'],
	['tourEmotion','fight'],
	['tourAnim','jump'],
	['tourSerifAddLine','下次！下次一定要好好表现才行了！'],
	['pauseUntilTapScreen'],
	['tourSerifHide'],
	['tourAnim','leave'],
	['clipRect',286,48,32,26],//剩余客户
	['typeText','营业活动的时候，客户会不止一位',10,90],
	['pauseUntilTapScreen'],
	['typeText','每次派遣结束之后，新的客户会进来',10,90],
	['pauseUntilTapScreen'],
	['typeText','不管是我们还是竟争者，之前派遣成功的女仆都不能再次被派出',10,90],
	['pauseUntilTapScreen'],
	['typeText','当所有客户都选择完女仆之后，这次的营业活动就结束了',10,90],
	['pauseUntilTapScreen'],
	['clearText'],
	['clipRect',0,0,0,0],
	['tourAnim','show'],
	['tourEmotion','normal2'],
	['pauseByTime',280],
	['tourSerifShow'],
	['tourSerifSay','那么我们继续营业活动吧！'],
	['pauseUntilTapScreen'],
	['tourEmotion','smile2'],
	['tourAnim','jump'],
	['tourSerifAddLine','太好了！这次的客户对我们来说优势很大呢！'],
	['pauseUntilTapScreen'],
	['tourAnim','jump'],
	['tourSerifAddLine','嗯？看不出来吗？这里啦这里！'],
	['clipRect',181,156,112,22],//特殊癖好
	['pauseUntilTapScreen'],
	['tourSerifHide'],
	['tourAnim','leave'],
	['typeText','有些客户会有特殊的癖好',10,120],
	['pauseUntilTapScreen'],
	['clipRect',10,470,36,24],//捆绑
	['typeText','如果女仆正好携带着这样的属性，就会更强烈的吸引客户',10,420],
	['pauseUntilTapScreen'],
	['clipRect',109,522,102,46],//派遣
	['typeText','直接派遣试试吧',10,470],
	['pauseUntilTapRect',109,522,102,46],
	['clearText'],
	['simTouchElement','.action button'],
	['clearClipRect'],
	['pauseByTime',4850],
	['pauseUntilTapScreen'],
	['simTouchElement','.result'],
	['clipRect',0,0,0,0],
	['tourAnim','show'],
	['tourEmotion','smile'],
	['pauseByTime',280],
	['tourSerifShow'],
	['tourSerifSay','终于成功了呢！'],
	['pauseUntilTapScreen'],
	['tourAnim','jump'],
	['tourSerifAddLine','这样一来我们也招揽到一位客户了！'],
	['pauseUntilTapScreen'],
	['tourAnim','jump'],
	['tourSerifAddLine','现在所有客户都已经选择完了，接下来就要进入服务的环节了！'],
	['pauseUntilTapScreen'],
	['tourEmotion','angry'],
	['tourAnim','jump'],
	['tourSerifSay','啊～～！你在想什么啦！讨厌！'],
	['pauseUntilTapScreen']
]);


</script>