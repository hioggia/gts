<!doctype html>
<meta charset="utf-8" />
<h1>Equipment create helper</h1>
<p>What equipment do you want to create?
<p><select id="want"></select>
<p><strong>Basical material</strong>
<p id="basic">
<h2>Additional: what item(s) you already owned?</h2>
<p><select id="owned"></select> x<input type="number" value="1" id="num" style="width:22px" /> <button id="add">Add</button>
<p id="bank_head" style="display:none"><strong>Your bank:</strong>
<ul id="bank_content" style="display:none"></ul>
<p><button id="show">Show me what is I need to collect</button>
<p id="result">
<script>
	var getJSON = function(path,callback){
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function(){
			if(xhr.readyState == 4){
				if(xhr.status == 200){
					var data = JSON.parse(xhr.responseText);
					xhr = null;
					callback(data);
				}else{
					xhr = null;
					alert('READ JSON ERROR!');
				}
			}
		}
		xhr.open('get',path,true);
		xhr.send();
	};

	var elWant = document.querySelector('#want'), elBasic = document.querySelector('#basic'), elOwned = document.querySelector('#owned'), elNum = document.querySelector('#num'), elAdd = document.querySelector('#add'), elBankHead = document.querySelector('#bank_head'), elBank = document.querySelector('#bank_content'), elShow = document.querySelector('#show'), elResult = document.querySelector('#result');

	var addBasical = function(material,isChecked,isReadonly){
		var label = document.createElement('label'), htw = '';
		htw = '<input type="checkbox"';
		if(isChecked){
			htw += ' checked="checked"';
		}
		if(isReadonly){
			htw += ' disabled="disabled"';
		}
		label.innerHTML = htw+' /> '+material;
		label.dataset.ma = material;
		elBasic.appendChild(label);
	};

	var splitEquipment = function(eq){
		if(eq in craftTree){
			return craftTree[eq];
		}
		return [];
	};

	var iterRun = function(eq){
		if(eq in bank){
			if(eq in used){
				if(bank[eq]-used[eq]>0){
					used[eq]+=1;
					return [];
				}
			}else{
				used[eq]++;
				return [];
			}
		}
		if(eq in basic){
			return eq;
		}else{
			var seq = splitEquipment(eq), ret = [];
			for(var i=0,l=seq.length;i<l;i++){
				ret = ret.concat(iterRun(seq[i]));
			}
			return ret;
		}
	};

	var addOwnMaterial = function(){
		if(elBankHead.style.cssText){
			elBankHead.style.cssText = '';
			elBank.style.cssText = '';
		}
		var eq = elOwned.value, sz = ~~elNum.value;
		if(bank[eq]){
			bank[eq]+=sz;
			elBank.querySelector('[data-eq="'+eq+'"]').innerHTML = eq+' x'+bank[eq]+' <a href="javascript:void(0)">[remove]</a>';
		}else{
			bank[eq]=sz;
			var li = document.createElement('li');
			li.innerHTML = eq+' x'+sz+' <a href="javascript:void(0)">[remove]</a>';
			li.dataset.eq = eq;
			elBank.appendChild(li);
		}
	};

	var removeOwnMaterial = function(ev){
		if(ev.target.tagName.toLowerCase() == 'a'){
			var li = ev.target.parentNode;
			var eq = li.dataset.eq;
			delete bank[eq];
			elBank.removeChild(li);
			if(elBank.childElementCount==0){
				elBankHead.style.display='none';
				elBank.style.display='none';
			}
		}
	};

	var showColletMaterial = function(){
		var eq = elWant.value;
		basic = {}, used = {};
		for(var i=0,l=elBasic.children.length;i<l;i++){
			var label = elBasic.children[i];
			if(label.querySelector('input').checked){
				basic[label.dataset.ma] = true;
			}
		}
		var result = iterRun(eq);
		elResult.innerHTML = result;
	};

	var initPage = function(){
		for(var key in dropabelMaterial){
			addBasical(key,true,!(key in craftTree));
			elOwned.add(new Option(key));
		}

		for(var key in craftTree){
			elWant.add(new Option(key));
			if(!(key in dropabelMaterial)){
				elOwned.add(new Option(key));
			}
		}

		elAdd.addEventListener('click',addOwnMaterial,false);
		elBank.addEventListener('click',removeOwnMaterial,false);
		elShow.addEventListener('click',showColletMaterial,false);
	};

	var craftTree = {}, dropabelMaterial = {}, bank = {}, used = {}, basic = {};

	getJSON('equipment.json',function(data){
		craftTree = data;
		getJSON('material.json',function(data){
			dropabelMaterial = data;

			initPage();
		});
	});
</script>